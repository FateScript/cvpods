

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>&lt;no title&gt; &mdash; cvpods 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="compatibility.html" />
    <link rel="prev" title="Notes" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> cvpods
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">cvpods</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Notes</a> &raquo;</li>
        
      <li>&lt;no title&gt;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/notes/benchmarks.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p># Benchmarks</p>
<p>Here we benchmark the training speed of a Mask R-CNN in cvpods,
with some other popular open source Mask R-CNN implementations.</p>
<p>### Settings</p>
<ul class="simple">
<li><p>Hardware: 8 NVIDIA V100s with NVLink.</p></li>
<li><p>Software: Python 3.7, CUDA 10.0, cuDNN 7.6.4, PyTorch 1.3.0 (at
[this link](<a class="reference external" href="https://download.pytorch.org/whl/nightly/cu100/torch-1.3.0%2Bcu100-cp37-cp37m-linux_x86_64.whl">https://download.pytorch.org/whl/nightly/cu100/torch-1.3.0%2Bcu100-cp37-cp37m-linux_x86_64.whl</a>)),
TensorFlow 1.15.0rc2, Keras 2.2.5, MxNet 1.6.0b20190820.</p></li>
<li><dl class="simple">
<dt>Model: an end-to-end R-50-FPN Mask-RCNN model, using the same hyperparameter as the</dt><dd><p>[cvpack baseline config](<a class="reference external" href="https://git-core.megvii-inc.com/zhubenjin/cvpods_playground/tree/master/examples/rcnn/mask_rcnn.res50.fpn.coco.800size.1x">https://git-core.megvii-inc.com/zhubenjin/cvpods_playground/tree/master/examples/rcnn/mask_rcnn.res50.fpn.coco.800size.1x</a>).</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Metrics: We use the average throughput in iterations 100-500 to skip GPU warmup time.</dt><dd><p>Note that for R-CNN-style models, the throughput of a model typically changes during training, because
it depends on the predictions of the model. Therefore this metric is not directly comparable with
“train speed” in model zoo, which is the average speed of the entire training run.</p>
</dd>
</dl>
</li>
</ul>
<p>### Main Results</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id20"><span class="problematic" id="id21">`eval_rst
+-------------------------------+--------------------+
| Implementation                | Throughput (img/s) |
+===============================+====================+
| |D2| |PT|                     | 59                 |
+-------------------------------+--------------------+
| maskrcnn-benchmark_  |PT|     | 51                 |
+-------------------------------+--------------------+
| tensorpack_ |TF|              | 50                 |
+-------------------------------+--------------------+
| mmdetection_  |PT|            | 41                 |
+-------------------------------+--------------------+
| simpledet_ |mxnet|            | 39                 |
+-------------------------------+--------------------+
| Detectron_  |C2|              | 19                 |
+-------------------------------+--------------------+
| `matterport/Mask_RCNN`__</span></a> <a class="reference external" href="https://tensorflow.org"><img alt="TF" src="https://static.nvidiagrid.net/ngc/containers/tensorflow.png" style="width: 15pt; height: 15pt;" /></a> | 14                 |
+——————————-+——————–+</p>
<p><a href="#id4"><span class="problematic" id="id5">``</span></a><a href="#id6"><span class="problematic" id="id7">`</span></a></p>
<p>Details for each implementation:</p>
<ul>
<li><p>__cvpods__:
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">cvpods_train</span> <span class="pre">--num-gpus</span> <span class="pre">8</span>
<span class="pre">`</span></code></p></li>
<li><p>__maskrcnn-<a href="#id20"><span class="problematic" id="id22">benchmark__</span></a>: use commit <cite>0ce8f6f</cite> with <cite>sed -i ‘s/torch.uint8/torch.bool/g’ **/*.py</cite> to make it compatible with latest PyTorch.
Then, run training with
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">python</span> <span class="pre">-m</span> <span class="pre">torch.distributed.launch</span> <span class="pre">--nproc_per_node=8</span> <span class="pre">tools/train_net.py</span> <span class="pre">--config-file</span> <span class="pre">configs/e2e_mask_rcnn_R_50_FPN_1x.yaml</span>
<span class="pre">`</span></code>
The speed we observed is faster than its model zoo, likely due to different software versions.</p></li>
<li><p>__tensorpack__: at commit <cite>caafda</cite>, <cite>export TF_CUDNN_USE_AUTOTUNE=0</cite>, then run
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">mpirun</span> <span class="pre">-np</span> <span class="pre">8</span> <span class="pre">./train.py</span> <span class="pre">--config</span> <span class="pre">DATA.BASEDIR=/data/coco</span> <span class="pre">TRAINER=horovod</span> <span class="pre">BACKBONE.STRIDE_1X1=True</span> <span class="pre">TRAIN.STEPS_PER_EPOCH=50</span> <span class="pre">--load</span> <span class="pre">ImageNet-R50-AlignPadding.npz</span>
<span class="pre">`</span></code></p></li>
<li><dl>
<dt>__mmdetection__: at commit <cite>4d9a5f</cite>, apply the following diff, then run</dt><dd><blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">./tools/dist_train.sh</span> <span class="pre">configs/mask_rcnn_r50_fpn_1x.py</span> <span class="pre">8</span>
<span class="pre">`</span></code></p>
</div></blockquote>
<p>The speed we observed is faster than its model zoo, likely due to different software versions.</p>
<blockquote>
<div><p>&lt;details&gt;
&lt;summary&gt;
(diff to make it use the same architecture - click to expand)
&lt;/summary&gt;
<a href="#id8"><span class="problematic" id="id9">``</span></a><a href="#id10"><span class="problematic" id="id11">`</span></a>diff
diff –git i/configs/mask_rcnn_r50_fpn_1x.py w/configs/mask_rcnn_r50_fpn_1x.py
index 04f6d22..ed721f2 100644
— i/configs/mask_rcnn_r50_fpn_1x.py
+++ w/configs/mask_rcnn_r50_fpn_1x.py
&#64;&#64; -1,14 +1,15 &#64;&#64;
# model settings
model = dict(</p>
<blockquote>
<div><p>type=’MaskRCNN’,</p>
</div></blockquote>
<ul class="simple">
<li><p>pretrained=’torchvision://resnet50’,</p></li>
</ul>
<ul class="simple">
<li><dl class="simple">
<dt>pretrained=’open-mmlab://resnet50_caffe’,</dt><dd><dl class="simple">
<dt>backbone=dict(</dt><dd><p>type=’ResNet’,
depth=50,
num_stages=4,
out_indices=(0, 1, 2, 3),
frozen_stages=1,</p>
</dd>
</dl>
</dd>
</dl>
</li>
</ul>
<ul class="simple">
<li><p>style=’pytorch’),</p></li>
</ul>
<ul class="simple">
<li><p>norm_cfg=dict(type=”BN”, requires_grad=False),</p></li>
<li><p>style=’caffe’),</p></li>
</ul>
<blockquote>
<div><dl class="simple">
<dt>neck=dict(</dt><dd><p>type=’FPN’,
in_channels=[256, 512, 1024, 2048],</p>
</dd>
</dl>
</div></blockquote>
<p>&#64;&#64; -115,7 +116,7 &#64;&#64; test_cfg = dict(
dataset_type = ‘CocoDataset’
data_root = ‘data/coco/’
img_norm_cfg = dict(
-    mean=[123.675, 116.28, 103.53], std=[58.395, 57.12, 57.375], to_rgb=True)
+    mean=[123.675, 116.28, 103.53], std=[1.0, 1.0, 1.0], to_rgb=False)
train_pipeline = [</p>
<blockquote>
<div><p>dict(type=’LoadImageFromFile’),
dict(type=’LoadAnnotations’, with_bbox=True, with_mask=True),</p>
</div></blockquote>
<p><a href="#id12"><span class="problematic" id="id13">``</span></a>`
&lt;/details&gt;</p>
</div></blockquote>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>__SimpleDet__: at commit <cite>9187a1</cite>, run</dt><dd><p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">python</span> <span class="pre">detection_train.py</span> <span class="pre">--config</span> <span class="pre">config/mask_r50v1_fpn_1x.py</span>
<span class="pre">`</span></code></p>
</dd>
</dl>
</li>
<li><p>__cvpods__: run
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">cvpods_train</span> <span class="pre">--num-gpus</span> <span class="pre">8</span>
<span class="pre">`</span></code>
Note that many of its ops run on CPUs, therefore the performance is limited.</p></li>
<li><dl class="simple">
<dt>__matterport/<a href="#id20"><span class="problematic" id="id23">Mask_RCNN__</span></a>: at commit <cite>3deaec</cite>, apply the following diff, <cite>export TF_CUDNN_USE_AUTOTUNE=0</cite>, then run</dt><dd><p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">python</span> <span class="pre">coco.py</span> <span class="pre">train</span> <span class="pre">--dataset=/data/coco/</span> <span class="pre">--model=imagenet</span>
<span class="pre">`</span></code></p>
</dd>
</dl>
<p>Note that many small details in this implementation might be different
from cvpods’s standards.</p>
<blockquote>
<div><p>&lt;details&gt;
&lt;summary&gt;
(diff to make it use the same hyperparameters - click to expand)
&lt;/summary&gt;
<a href="#id14"><span class="problematic" id="id15">``</span></a><a href="#id16"><span class="problematic" id="id17">`</span></a>diff
diff –git i/mrcnn/model.py w/mrcnn/model.py
index 62cb2b0..61d7779 100644
— i/mrcnn/model.py
+++ w/mrcnn/model.py
&#64;&#64; -2367,8 +2367,8 &#64;&#64; class MaskRCNN():</p>
<blockquote>
<div><p>epochs=epochs,
steps_per_epoch=self.config.STEPS_PER_EPOCH,
callbacks=callbacks,</p>
</div></blockquote>
<ul class="simple">
<li><p>validation_data=val_generator,</p></li>
<li><p>validation_steps=self.config.VALIDATION_STEPS,</p></li>
</ul>
<ul class="simple">
<li><p>#validation_data=val_generator,</p></li>
<li><dl class="simple">
<dt>#validation_steps=self.config.VALIDATION_STEPS,</dt><dd><p>max_queue_size=100,
workers=workers,
use_multiprocessing=True,</p>
</dd>
</dl>
</li>
</ul>
<p>diff –git i/mrcnn/parallel_model.py w/mrcnn/parallel_model.py
index d2bf53b..060172a 100644
— i/mrcnn/parallel_model.py
+++ w/mrcnn/parallel_model.py
&#64;&#64; -32,6 +32,7 &#64;&#64; class ParallelModel(KM.Model):</p>
<blockquote>
<div><p>keras_model: The Keras model to parallelize
gpu_count: Number of GPUs. Must be &gt; 1
“””</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>super().__init__()</dt><dd><p>self.inner_model = keras_model
self.gpu_count = gpu_count
merged_outputs = self.make_parallel()</p>
</dd>
</dl>
</li>
</ul>
<p>diff –git i/samples/coco/coco.py w/samples/coco/coco.py
index 5d172b5..239ed75 100644
— i/samples/coco/coco.py
+++ w/samples/coco/coco.py
&#64;&#64; -81,7 +81,10 &#64;&#64; class CocoConfig(Config):</p>
<blockquote>
<div><p>IMAGES_PER_GPU = 2</p>
<p># Uncomment to train on 8 GPUs (default is 1)</p>
</div></blockquote>
<ul class="simple">
<li><p># GPU_COUNT = 8</p></li>
</ul>
<ul>
<li><p>GPU_COUNT = 8</p></li>
<li><p>BACKBONE = “resnet50”</p></li>
<li><p>STEPS_PER_EPOCH = 50</p></li>
<li><p>TRAIN_ROIS_PER_IMAGE = 512</p>
<blockquote>
<div><p># Number of classes (including background)
NUM_CLASSES = 1 + 80  # COCO has 80 classes</p>
</div></blockquote>
</li>
</ul>
<dl>
<dt>&#64;&#64; -496,29 +499,10 &#64;&#64; if __name__ == ‘__main__’:</dt><dd><p># <strong>* This training schedule is an example. Update to your needs *</strong></p>
<p># Training - Stage 1</p>
</dd>
</dl>
<ul class="simple">
<li><dl class="simple">
<dt>print(“Training network heads”)</dt><dd><dl class="simple">
<dt>model.train(dataset_train, dataset_val,</dt><dd><p>learning_rate=config.LEARNING_RATE,
epochs=40,</p>
</dd>
</dl>
</dd>
</dl>
</li>
<li><p>layers=’heads’,</p></li>
<li><p>augmentation=augmentation)</p></li>
<li></li>
<li><p># Training - Stage 2</p></li>
<li><p># Finetune layers from ResNet stage 4 and up</p></li>
<li><p>print(“Fine tune Resnet stage 4 and up”)</p></li>
<li><p>model.train(dataset_train, dataset_val,</p></li>
<li><p>learning_rate=config.LEARNING_RATE,</p></li>
<li><p>epochs=120,</p></li>
<li><p>layers=’4+’,</p></li>
<li><p>augmentation=augmentation)</p></li>
<li></li>
<li><p># Training - Stage 3</p></li>
<li><p># Fine tune all layers</p></li>
<li><p>print(“Fine tune all layers”)</p></li>
<li><p>model.train(dataset_train, dataset_val,</p></li>
<li><p>learning_rate=config.LEARNING_RATE / 10,</p></li>
<li><p>epochs=160,</p></li>
<li><p>layers=’all’,</p></li>
</ul>
<ul class="simple">
<li><dl class="simple">
<dt>layers=’3+’,</dt><dd><p>augmentation=augmentation)</p>
</dd>
</dl>
</li>
</ul>
<blockquote>
<div><p>elif args.command == “evaluate”:</p>
</div></blockquote>
<p><a href="#id18"><span class="problematic" id="id19">``</span></a>`
&lt;/details&gt;</p>
</div></blockquote>
</li>
</ul>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="compatibility.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Notes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, cvpods contributors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>