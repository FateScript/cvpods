

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>&lt;no title&gt; &mdash; cvpods 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="models.html" />
    <link rel="prev" title="&lt;no title&gt;" href="datasets.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> cvpods
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/index.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">cvpods</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Tutorials</a> &raquo;</li>
        
      <li>&lt;no title&gt;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/data_loading.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p># Use Custom Dataloaders</p>
<p>## How the Existing Dataloader Works</p>
<p>cvpods contains a builtin data loading pipeline.
It’s good to understand how it works, in case you need to write a custom one.</p>
<p>cvpods provides two functions
[build_detection_{train,test}_loader](../modules/data.html#cvpods.data.build_detection_train_loader)
that create a default data loader from a given config.
Here is how <cite>build_detection_{train,test}_loader</cite> work:</p>
<ol class="arabic">
<li><p>It takes the name of a registered dataset (e.g., “coco_2017_train”) and loads a <cite>list[dict]</cite> representing the dataset items
in a lightweight, canonical format. These dataset items are not yet ready to be used by the model (e.g., images are
not loaded into memory, random augmentations have not been applied, etc.).
Details about the dataset format and dataset registration can be found in
[datasets](datasets.html).</p></li>
<li><dl class="simple">
<dt>Each dict in this list is mapped by a function (“mapper”):</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Users can customize this mapping function by specifying the “mapper” argument in</dt><dd><p><cite>build_detection_{train,test}_loader</cite>. The default mapper is [DatasetMapper]( ../modules/data.html#detectron2.data.DatasetMapper).</p>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
<ul>
<li><p>The output format of such function can be arbitrary, as long as it is accepted by the consumer of this data loader (usually the model).
The outputs of the default mapper, after batching, follow the default model input format documented in
[Use Models](<a class="reference external" href="https://detectron2.readthedocs.io/tutorials/models.html#model-input-format">https://detectron2.readthedocs.io/tutorials/models.html#model-input-format</a>).</p></li>
<li><p>The role of the mapper is to transform the lightweight, canonical representation of a dataset item into a format
that is ready for the model to consume (including, e.g., read images, performe random data augmentation and convert to torch Tensors).
If you would like to perform custom transformations to data, you often want a custom mapper.</p>
<blockquote>
<div><p>The output format of the default mapper is explained below.</p>
</div></blockquote>
</li>
</ul>
</li>
<li><p>The outputs of the mapper are batched (simply into a list).</p></li>
<li><p>This batched data is the output of the data loader. Typically, it’s also the input of
<cite>model.forward()</cite>.</p></li>
</ol>
<p>## Write a Custom Dataloader</p>
<p>Using a different “mapper” with <cite>build_detection_{train,test}_loader(mapper=)</cite> works for most use cases
of custom data loading.
For example, if you want to resize all images to a fixed size for Mask R-CNN training, write this:</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>python
from detectron2.data import build_detection_train_loader
from detectron2.data import transforms as T
from detectron2.data import detection_utils as utils
def mapper(dataset_dict):</p>
<blockquote>
<div><p># Implement a mapper, similar to the default DatasetMapper, but with your own customizations
dataset_dict = copy.deepcopy(dataset_dict)  # it will be modified by code below
image = utils.read_image(dataset_dict[“file_name”], format=”BGR”)
image, transforms = T.apply_transform_gens([T.Resize((800, 800))], image)
dataset_dict[“image”] = torch.as_tensor(image.transpose(2, 0, 1).astype(“float32”))
annos = [</p>
<blockquote>
<div><p>utils.transform_instance_annotations(obj, transforms, image.shape[:2])
for obj in dataset_dict.pop(“annotations”)
if obj.get(“iscrowd”, 0) == 0</p>
</div></blockquote>
<p>]
instances = utils.annotations_to_instances(annos, image.shape[:2])
dataset_dict[“instances”] = utils.filter_empty_instances(instances)
return dataset_dict</p>
</div></blockquote>
<p>data_loader = build_detection_train_loader(cfg, mapper=mapper)
# use this dataloader instead of the default
<a href="#id5"><span class="problematic" id="id6">``</span></a>`
Refer to [API documentation of detectron2.data](../modules/data.html) for details.</p>
<p>If you want to change not only the mapper (e.g., to write different sampling or batching logic),
you can write your own data loader. The data loader is simply a
python iterator that produces [the format](models.html) your model accepts.
You can implement it using any tools you like.</p>
<p>## Use a Custom Dataloader</p>
<p>If you use [DefaultTrainer](../modules/engine.html#detectron2.engine.defaults.DefaultTrainer),
you can overwrite its <cite>build_{train,test}__loader</cite> method to use your own dataloader.
See the [densepose dataloader](/projects/DensePose/densepose/train_net.py)
for an example.</p>
<p>If you write your own training loop, you can plug in your data loader easily.</p>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="models.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="datasets.html" class="btn btn-neutral float-left" title="&lt;no title&gt;" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, cvpods contributors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>