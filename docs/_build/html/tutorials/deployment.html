

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>&lt;no title&gt; &mdash; cvpods 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Notes" href="../notes/index.html" />
    <link rel="prev" title="&lt;no title&gt;" href="configs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> cvpods
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notes/index.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">cvpods</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Tutorials</a> &raquo;</li>
        
      <li>&lt;no title&gt;</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/deployment.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p># Deployment</p>
<p>## Caffe2 Deployment
We currently support converting a cvpods model to Caffe2 format through ONNX.
The converted Caffe2 model is able to run without detectron2 dependency in either Python or C++.
It has a runtime optimized for CPU &amp; mobile inference, but not for GPU inference.</p>
<p>Caffe2 conversion requires PyTorch ≥ 1.4 and ONNX ≥ 1.6.</p>
<p>### Coverage</p>
<p>It supports 3 most common meta architectures: <cite>GeneralizedRCNN</cite>, <cite>RetinaNet</cite>, <cite>PanopticFPN</cite>,
and almost all official models under these 3 meta architectures.</p>
<p>Users’ custom extensions under these architectures (added through registration) are supported
as long as they do not contain control flow or operators not available in Caffe2 (e.g. deformable convolution).
For example, custom backbones and heads are often supported out of the box.</p>
<p>### Usage</p>
<p>The conversion APIs are documented at [the API documentation](../modules/export.html).
We provide a tool, <cite>tools/caffe2_converter.py</cite> as an example that uses
these APIs to convert a standard model.</p>
<p>To convert an official Mask R-CNN trained on COCO, first
[prepare the COCO dataset](../../datasets/), then pick the model from [Model Zoo](../../MODEL_ZOO.md), and run:
<a href="#id1"><span class="problematic" id="id2">``</span></a>`
python tools/caffe2_converter.py –config-file configs/COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml </p>
<blockquote>
<div><blockquote>
<div><p>–output ./caffe2_model –run-eval </p>
</div></blockquote>
<dl class="simple">
<dt>MODEL.WEIGHTS detectron2://COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x/137849600/model_final_f10217.pkl </dt><dd><p>MODEL.DEVICE cpu</p>
</dd>
</dl>
</div></blockquote>
<p><a href="#id3"><span class="problematic" id="id4">``</span></a><a href="#id5"><span class="problematic" id="id6">`</span></a></p>
<p>Note that:
1. The conversion needs valid sample inputs &amp; weights to trace the model. That’s why the script requires the dataset.</p>
<blockquote>
<div><p>You can modify the script to obtain sample inputs in other ways.</p>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>GPU conversion is supported only with Pytorch’s master. So we use <cite>MODEL.DEVICE cpu</cite>.</p></li>
<li><p>With the <cite>–run-eval</cite> flag, it will evaluate the converted models to verify its accuracy.
The accuracy is typically slightly different (within 0.1 AP) from PyTorch due to</p>
<blockquote>
<div><p>numerical precisions between different implementations.
It’s recommended to always verify the accuracy in case your custom model is not supported by the
conversion.</p>
</div></blockquote>
</li>
</ol>
<p>The converted model is available at the specified <cite>caffe2_model/</cite> directory. Two files <cite>model.pb</cite>
and <cite>model_init.pb</cite> that contain network structure and network parameters are necessary for deployment.
These files can then be loaded in C++ or Python using Caffe2’s APIs.</p>
<p>The script generates <cite>model.svg</cite> file which contains a visualization of the network.
You can also load <cite>model.pb</cite> to tools such as [netron](<a class="reference external" href="https://github.com/lutzroeder/netron">https://github.com/lutzroeder/netron</a>) to visualize it.</p>
<p>### Inputs &amp; Outputs</p>
<p>All converted models take two input tensors:
“data” which is an NCHW image, and “im_info” which is a Nx3 tensor of (height, width, unused legacy parameter) for
each image (the shape of “data” might be larger than that in “im_info” due to padding).</p>
<p>The converted models do not contain post-processing operations that
transform raw layer outputs into formatted predictions.
The models only produce raw outputs from the final
layers that are not post-processed, because in actual deployment, an application often needs
its custom lightweight post-processing (e.g. full-image masks for every detected object is often not necessary).</p>
<p>Due to different inputs &amp; outputs formats, the <cite>Caffe2Model.__call__</cite> method includes
pre/post-processing code in order to match the formats of original detectron2 models.
They can serve as a reference for pre/post-processing in actual deployment.</p>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../notes/index.html" class="btn btn-neutral float-right" title="Notes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="configs.html" class="btn btn-neutral float-left" title="&lt;no title&gt;" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, cvpods contributors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>